From 2ab0489311861941b480573b152d503c137925cc Mon Sep 17 00:00:00 2001
From: Niels Dossche <7771979+nielsdos@users.noreply.github.com>
Date: Tue, 19 Mar 2024 23:42:10 +0100
Subject: [PATCH] Patches

---
 apisan                                                       | 2 +-
 llvm/projects/compiler-rt/lib/asan/asan_linux.cc             | 2 +-
 .../compiler-rt/lib/sanitizer_common/sanitizer_linux.h       | 3 +--
 .../sanitizer_common/sanitizer_stoptheworld_linux_libcdep.cc | 5 +++--
 .../projects/compiler-rt/lib/tsan/rtl/tsan_platform_linux.cc | 2 +-
 5 files changed, 7 insertions(+), 7 deletions(-)

diff --git a/apisan b/apisan
index d2dd9499..205cca47 100755
--- a/apisan
+++ b/apisan
@@ -1,4 +1,4 @@
 #!/bin/bash
 DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
 APISAN_DIR=$DIR/analyzer
-PYTHONPATH=$APISAN_DIR:$PYTHONPATH $APISAN_DIR/bin/main.py $@
+PYTHONPATH=$APISAN_DIR:$PYTHONPATH python3 $APISAN_DIR/bin/main.py $@
diff --git a/llvm/projects/compiler-rt/lib/asan/asan_linux.cc b/llvm/projects/compiler-rt/lib/asan/asan_linux.cc
index fdd009c9..e6f2e29d 100644
--- a/llvm/projects/compiler-rt/lib/asan/asan_linux.cc
+++ b/llvm/projects/compiler-rt/lib/asan/asan_linux.cc
@@ -221,7 +221,7 @@ void GetPcSpBp(void *context, uptr *pc, uptr *sp, uptr *bp) {
 }
 
 bool AsanInterceptsSignal(int signum) {
-  return signum == SIGSEGV && common_flags()->handle_segv;
+  return signum == 11 && common_flags()->handle_segv;
 }
 
 void AsanPlatformThreadInit() {
diff --git a/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_linux.h b/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_linux.h
index 3013c25f..f2560877 100644
--- a/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_linux.h
+++ b/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_linux.h
@@ -12,7 +12,6 @@
 //===----------------------------------------------------------------------===//
 #ifndef SANITIZER_LINUX_H
 #define SANITIZER_LINUX_H
-
 #include "sanitizer_platform.h"
 #if SANITIZER_FREEBSD || SANITIZER_LINUX
 #include "sanitizer_common.h"
@@ -20,7 +19,7 @@
 #include "sanitizer_platform_limits_posix.h"
 
 struct link_map;  // Opaque type returned by dlopen().
-struct sigaltstack;
+//struct sigaltstack;
 
 namespace __sanitizer {
 // Dirent structure for getdents(). Note that this structure is different from
diff --git a/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_stoptheworld_linux_libcdep.cc b/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_stoptheworld_linux_libcdep.cc
index d20b5248..79b1a453 100644
--- a/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_stoptheworld_linux_libcdep.cc
+++ b/llvm/projects/compiler-rt/lib/sanitizer_common/sanitizer_stoptheworld_linux_libcdep.cc
@@ -12,7 +12,6 @@
 //
 //===----------------------------------------------------------------------===//
 
-
 #include "sanitizer_platform.h"
 #if SANITIZER_LINUX && defined(__x86_64__)
 
@@ -233,7 +232,7 @@ static int TracerThread(void* argument) {
   ThreadSuspender thread_suspender(internal_getppid());
   // Global pointer for the signal handler.
   thread_suspender_instance = &thread_suspender;
-
+#if 0
   // Alternate stack for signal handling.
   InternalScopedBuffer<char> handler_stack_memory(kHandlerStackSize);
   struct sigaltstack handler_stack;
@@ -269,6 +268,8 @@ static int TracerThread(void* argument) {
   handler_stack.ss_flags = SS_DISABLE;
   internal_sigaltstack(&handler_stack, NULL);
   return exit_code;
+#endif
+  return 0;
 }
 
 class ScopedStackSpaceWithGuard {
diff --git a/llvm/projects/compiler-rt/lib/tsan/rtl/tsan_platform_linux.cc b/llvm/projects/compiler-rt/lib/tsan/rtl/tsan_platform_linux.cc
index 46b648cd..f36e55ff 100644
--- a/llvm/projects/compiler-rt/lib/tsan/rtl/tsan_platform_linux.cc
+++ b/llvm/projects/compiler-rt/lib/tsan/rtl/tsan_platform_linux.cc
@@ -379,7 +379,7 @@ bool IsGlobalVar(uptr addr) {
 int ExtractResolvFDs(void *state, int *fds, int nfd) {
 #if SANITIZER_LINUX
   int cnt = 0;
-  __res_state *statp = (__res_state*)state;
+  struct __res_state *statp = (struct __res_state*)state;
   for (int i = 0; i < MAXNS && cnt < nfd; i++) {
     if (statp->_u._ext.nsaddrs[i] && statp->_u._ext.nssocks[i] != -1)
       fds[cnt++] = statp->_u._ext.nssocks[i];
-- 
2.44.0

